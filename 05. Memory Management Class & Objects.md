# C# Memory Management â€“ Stack & Heap (Lineâ€‘byâ€‘Line Visualization with Methods)

> **Goal:** *Visually understand* how memory works inside the computer when C# code runs â€” including **fields**, **method variables**, and **object lifetimes**.

---

## 1ï¸âƒ£ Big Picture First (Interviewâ€‘Friendly Truth)

- **Stack**
  - Stores **method call frames**
  - Stores **local variables** (value types directly, references as addresses)
  - Automatically cleaned when a method ends

- **Heap**
  - Stores **objects** and **data referenced by references**
  - Managed by the **Garbage Collector (GC)**

- **Value Types** (`int`, `double`, `bool`, `struct`, `enum`)
  - Store the **actual value**
  - Live *inline with their container*

- **Reference Types** (`class`, `array`, `string`, `object`)
  - Store a **reference (address)**
  - Actual object lives on the **heap**

> ðŸ“Œ **Golden Rule:** *Value types live where their container lives. Fields follow their object.*

---

## 2ï¸âƒ£ Complete Example (Fields + Method Variables)

```csharp
enum Gender { Male, Female }

struct Address
{
    public int ZipCode;
}

class Company
{
    public string Name;
}

class Person
{
    // VALUEâ€‘TYPE FIELDS
    public int Age;
    public double Salary;
    public bool IsActive;
    public DateTime BirthDate;
    public Address HomeAddress;
    public Gender Gender;

    // REFERENCEâ€‘TYPE FIELDS
    public string Name;
    public object Tag;
    public int[] Scores;
    public Company Employer;

    // METHOD WITH LOCAL VARIABLES
    public void UpdateProfile()
    {
        int bonus = 1000;                 // value type
        double taxRate = 0.1;             // value type
        bool eligible = true;             // value type
        Address tempAddress;              // struct (value type)

        string message = "Profile Updated"; // reference type
        Company tempCompany = new Company(); // reference type
        int[] localScores = new int[3];      // reference type
    }
}

void Main()
{
    Person p = new Person();
    p.UpdateProfile();
}
```

---

## 3ï¸âƒ£ Lineâ€‘byâ€‘Line Execution

---

### â–¶ Line 1: `void Main()` starts

A **stack frame** for `Main()` is created.

```
STACK                         HEAP
-----                         -----
| Main() |                    (empty)
```

---

### â–¶ Line 2: `Person p = new Person();`

Two things happen:
1. `p` (reference variable) is created on the **stack**
2. `Person` object is created on the **heap**

---

## 4ï¸âƒ£ Memory After Object Creation

### ðŸ”¹ Stack Memory

```
STACK
--------------------------------
| p |  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
--------------------------------
```

### ðŸ”¹ Heap Memory

```
HEAP
--------------------------------------------------
| Person Object                                   |
|------------------------------------------------|
| Age            : 0                              |
| Salary         : 0.0                            |
| IsActive       : false                          |
| BirthDate      : 01/01/0001                     |
| HomeAddress    : { ZipCode = 0 }                |
| Gender         : Male (0)                       |
| Name           : null                           |
| Tag            : null                           |
| Scores         : null                           |
| Employer       : null                           |
--------------------------------------------------
```

```
STACK                HEAP
-----                -----
 p  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Person Object
```

---

## 5ï¸âƒ£ Calling a Method: `p.UpdateProfile()`

- A **new stack frame** is created for `UpdateProfile()`

---

## 6ï¸âƒ£ Memory Inside `UpdateProfile()`

### ðŸ”¹ Stack (Method Frame)

```
STACK
--------------------------------------------------
| UpdateProfile()                                |
|------------------------------------------------|
| bonus        = 1000        (int)               |
| taxRate      = 0.1         (double)            |
| eligible     = true        (bool)              |
| tempAddress  = { ZipCode = 0 } (struct)        |
| message      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ "Profile Updated"   |
| tempCompany  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Company Object      |
| localScores  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ int[3] Array        |
--------------------------------------------------
| Main()                                         |
--------------------------------------------------
```

---

### ðŸ”¹ Heap During Method Execution

```
HEAP
--------------------------------------------------
| Person Object                                  |
--------------------------------------------------
| Company Object (tempCompany)                   |
| Name : null                                    |
--------------------------------------------------
| "Profile Updated" (string object)             |
--------------------------------------------------
| int[3] Array                                   |
| [0, 0, 0]                                      |
--------------------------------------------------
```

---

## 7ï¸âƒ£ Where Are Method Variables Stored?

### âœ… Valueâ€‘Type Local Variables

```
int bonus
double taxRate
bool eligible
Address tempAddress
```

âœ” Stored **directly on the STACK**  
âœ” Because they are **local variables**

---

### âœ… Referenceâ€‘Type Local Variables

```
string message
Company tempCompany
int[] localScores
```

- Reference â†’ **stack**
- Actual object â†’ **heap**

---

## 8ï¸âƒ£ When `UpdateProfile()` Ends

### ðŸ”¹ Stack Cleanup

```
STACK
---------------------
| Main() |
---------------------
```

- All local variables are **destroyed immediately**

### ðŸ”¹ Heap After Method Ends

- Objects created in the method have **no references**
- They become **eligible for Garbage Collection**

---
## 9ï¸âƒ£ Why `string` Is SPECIAL (Very Important Interview Topic)

Although `string` is a **reference type**:

- It is **immutable**
- Stored on the **heap**
- Uses **string interning** (may reuse same memory)

```csharp
string a = "Hello";
string b = "Hello";
```

```
STACK           HEAP
-----           -----
 a â”€â”           "Hello"
 b â”€â”˜              â–²
                   |
            (Same object reused)
```

> Value types are copied, strings are **shared & immutable**.
---

## ðŸ”Ÿ When `Main()` Ends

- Stack frame removed
- `p` reference destroyed
- `Person` object becomes **eligible for GC**

> âš ï¸ Garbage Collection is **nonâ€‘deterministic**

---

## 1ï¸âƒ£1ï¸âƒ£ Object Layout (Inside Heap)

```
Heap Memory Block
-----------------------------
| Object Header (CLR info)  |
| Age (int)                 |
| Salary (double)           |
| IsActive (bool)           |
| BirthDate (struct)        |
| HomeAddress (struct)      |
| Gender (enum)             |
| Name (reference)          |
| Tag (reference)           |
| Scores (reference)        |
| Employer (reference)      |
-----------------------------
```

---

## 1ï¸âƒ£2ï¸âƒ£ Summary Table (Interview Mustâ€‘Remember)

| Variable | Type | Stored Where | Why |
|--------|------|-------------|-----|
| `p` | Reference | Stack | Local variable |
| `Person object` | Class | Heap | Objects live on heap |
| `Age` | int | Heap | Field inside class |
| `bonus` | int | Stack | Local value type |
| `taxRate` | double | Stack | Local value type |
| `eligible` | bool | Stack | Local value type |
| `tempAddress` | struct | Stack | Local struct |
| `message` | string | Heap | Reference type |
| `tempCompany` | Company | Heap | Class instance |
| `localScores` | int[] | Heap | Array is reference type |

---

## 1ï¸âƒ£3ï¸âƒ£ Final Mental Model (Oneâ€‘Line Rule)

> **Stack stores method frames, local variables, and references. Heap stores objects. Fields follow their object. Value types live inline with their container.**

---

This single rule explains **90% of C# memory behavior**.

